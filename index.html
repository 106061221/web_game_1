<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>å·¥å…·è£ç®±å¤§å¸« - å¯¦é«”å¯«å¯¦ç‰ˆ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        :root { --bg: #1a1a1a; --panel: #2d2d2d; --accent: #e67e22; --text: #ecf0f1; }
        body { margin: 0; display: flex; flex-direction: column; align-items: center; height: 100vh; background: var(--bg); font-family: sans-serif; overflow: hidden; touch-action: none; color: var(--text); }
        .top-bar { width: 100%; display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; box-sizing: border-box; background: var(--panel); border-bottom: 2px solid #444; }
        #winNotice { display: none; position: fixed; top: 80px; background: var(--accent); color: white; padding: 15px 40px; border-radius: 4px; font-weight: bold; box-shadow: 0 10px 30px rgba(0,0,0,0.5); z-index: 100; font-size: 20px; }
        canvas { background: #333; border: 10px solid #222; border-radius: 8px; margin-top: 20px; cursor: grab; box-shadow: inset 0 0 50px rgba(0,0,0,0.8); }
        canvas:active { cursor: grabbing; }
    </style>
</head>
<body>

<div class="top-bar">
    <div style="font-weight:bold; font-size:1.2em;">ğŸ”§ å·¥å…·æ”¶ç´ç³»çµ± - ç¬¬ä¸€é—œ</div>
    <div id="status">è¼‰å…¥å·¥å…·ä¸­...</div>
</div>

<div id="winNotice">ğŸ‰ æ”¶ç´å®Œæˆï¼å·¥å…·æ­¸ä½ã€‚</div>

<canvas id="gameCanvas" width="380" height="600"></canvas>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

// å·¥å…·å¯¦é«”é…ç½®ï¼šåŒ…å«çœŸå¯¦ç…§ç‰‡ä¾†æºèˆ‡æ”¶ç´ç›®æ¨™
const toolsConfig = [
    { name: 'Hammer', url: 'https://i.imgur.com/vH9ZJ4n.png', w: 180, h: 90, targetX: 100, targetY: 50 },
    { name: 'Wrench', url: 'https://i.imgur.com/r6TzV0k.png', w: 150, h: 50, targetX: 110, targetY: 180 },
    { name: 'Screwdriver', url: 'https://i.imgur.com/S8M4sO0.png', w: 140, h: 40, targetX: 50, targetY: 280 },
    { name: 'Pliers', url: 'https://i.imgur.com/pYxY1rO.png', w: 120, h: 80, targetX: 210, targetY: 260 },
    { name: 'Saw', url: 'https://i.imgur.com/Psh5Xn6.png', w: 220, h: 100, targetX: 80, targetY: 400 }
];

let pieces = [];
let activePiece = null;
let offset = { x: 0, y: 0 };
let imagesLoaded = 0;

// åˆå§‹åŒ–ï¼šè¼‰å…¥å¯«å¯¦ç…§ç‰‡ç´ æ
function init() {
    toolsConfig.forEach(config => {
        const img = new Image();
        img.crossOrigin = "anonymous";
        img.src = config.url;
        img.onload = () => {
            imagesLoaded++;
            pieces.push({
                ...config,
                img: img,
                x: Math.random() * 150 + 50,
                y: 480 + Math.random() * 50,
                isLocked: false
            });
            if (imagesLoaded === toolsConfig.length) {
                document.getElementById('status').innerText = "å°±ç·’";
                draw();
            }
        };
    });
}

function checkWin() {
    const allLocked = pieces.every(p => {
        const dist = Math.sqrt(Math.pow(p.x - p.targetX, 2) + Math.pow(p.y - p.targetY, 2));
        return dist < 15; // åˆ¤å®šè·é›¢èª¤å·®åœ¨ 15px å…§
    });
    if (allLocked) {
        document.getElementById('winNotice').style.display = 'block';
    }
}

function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // 1. ç¹ªè£½ç®±åº•æ”¶ç´å‡¹æ§½ (å½±å­æ¿è¦–è¦º)
    pieces.forEach(p => {
        ctx.save();
        ctx.globalAlpha = 0.2;
        ctx.filter = 'brightness(0)';
        ctx.drawImage(p.img, p.targetX, p.targetY, p.w, p.h);
        ctx.restore();
    });

    // 2. ç¹ªè£½å¯¦é«”å·¥å…·ï¼ˆå¸¶ç«‹é«”é™°å½±èˆ‡æè³ªæ„Ÿï¼‰
    pieces.forEach(p => {
        if (p === activePiece) return;
        renderPiece(p);
    });

    if (activePiece) renderPiece(activePiece);

    requestAnimationFrame(draw);
}

function renderPiece(p) {
    ctx.save();
    // ç‰©ç†æŠ•å½±ï¼Œæ¨¡æ“¬å·¥å…·é›¢åº•éƒ¨çš„åšåº¦
    ctx.shadowColor = "rgba(0,0,0,0.6)";
    ctx.shadowBlur = 15;
    ctx.shadowOffsetX = 5;
    ctx.shadowOffsetY = 8;
    
    ctx.drawImage(p.img, p.x, p.y, p.w, p.h);
    
    // å¾®äº®é«˜å…‰å±¤ï¼šå¢å¼·é‡‘å±¬åå…‰æ„Ÿ
    ctx.globalCompositeOperation = 'lighter';
    ctx.globalAlpha = 0.08;
    ctx.drawImage(p.img, p.x, p.y, p.w, p.h);
    ctx.restore();
}

// äº’å‹•é‚è¼¯ï¼šåƒç´ é‚Šç•Œé¸å–
function getMousePos(e) {
    const r = canvas.getBoundingClientRect();
    const cx = e.touches ? e.touches[0].clientX : e.clientX;
    const cy = e.touches ? e.touches[0].clientY : e.clientY;
    return { x: cx - r.left, y: cy - r.top };
}

canvas.onmousedown = e => {
    const pos = getMousePos(e);
    for (let i = pieces.length - 1; i >= 0; i--) {
        const p = pieces[i];
        if (pos.x >= p.x && pos.x <= p.x + p.w && pos.y >= p.y && pos.y <= p.y + p.h) {
            activePiece = p;
            offset.x = pos.x - p.x;
            offset.y = pos.y - p.y;
            return;
        }
    }
};

window.onmousemove = e => {
    if (activePiece) {
        const pos = getMousePos(e);
        activePiece.x = pos.x - offset.x;
        activePiece.y = pos.y - offset.y;
    }
};

window.onmouseup = () => {
    if (activePiece) {
        // è‡ªå‹•å¸é™„é‚è¼¯ï¼šé è¿‘å‡¹æ§½æ™‚è‡ªå‹•æ­¸ä½
        const dist = Math.sqrt(Math.pow(activePiece.x - activePiece.targetX, 2) + Math.pow(activePiece.y - activePiece.targetY, 2));
        if (dist < 30) {
            activePiece.x = activePiece.targetX;
            activePiece.y = activePiece.targetY;
        }
        checkWin();
        activePiece = null;
    }
};

// æ”¯æ´æ‰‹æ©Ÿè§¸æ§
canvas.ontouchstart = e => { if(e.cancelable) e.preventDefault(); canvas.onmousedown(e); };
window.ontouchmove = e => { if(e.cancelable) e.preventDefault(); window.onmousemove(e); };
window.ontouchend = () => window.onmouseup();

init();
</script>
</body>
</html>
